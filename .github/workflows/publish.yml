name: Publish to Crates.io

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Publish pocket-tts
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish -p pocket-tts
      - name: Publish pocket-tts-cli
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          sleep 10 # Wait for crates.io to index common dependency
          cargo publish -p pocket-tts-cli
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            assets/ref.wav
            assets/ref_output.wav
            assets/ref_mimi_input.safetensors
            assets/ref_voice_conditioning.safetensors
            assets/ref_decoder_intermediates.safetensors
          body: |
            ## Pocket TTS v0.1.0 (Rust port)
            
            Initial release of the core Rust crates.
            
            > [!IMPORTANT]
            > The large file `ref_mimi_latents.safetensors` (210MB) must be manually uploaded to this release assets if it is not present, as it exceeds the repository's file size limit.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
